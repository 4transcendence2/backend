<!DOCTYPE html>
<html>

<head>
	<script src="https://cdn.socket.io/4.6.0/socket.io.min.js"
		integrity="sha384-c79GN5VsunZvi+Q/WObgk2in0CbZsHnjEqvFxC5DxHn9lTfNce2WW6h2pH6u/kF+"
		crossorigin="anonymous"></script>
	<script>
		


		
	</script>
	<meta charset="utf-8" />
	<title>Gamedev Canvas Workshop</title>
	<style>
		* {
			padding: 0;
			margin: 0;
		}

		canvas {
			background: #eee;
			display: block;
			margin: 0 auto;
		}
	</style>
</head>

<body>

	<canvas id="myCanvas" width="1080" height="720"></canvas>

	<script>
		const token = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJuYW1lIjoic29ya3NvZWsyIiwiaWQiOjEsInBob25lIjoiMDEwMjExNDU1MzciLCJpYXQiOjE2ODIxNzI4NzYsImV4cCI6MTY4MjQzMjA3Nn0.Oiuwh_SVT640qvJyEx2BuEmWhD8qy9Exf1hHE4XjC7Y';
		const socket = io('ws://localhost:81', {
			extraHeaders: {
				Authorization: 'Bearer ' + token,
			}
		})

		socket.emit('searchGame', {
			rule: 'normal'
		});
		socket.on('searchGameResult', data => {
			console.log(data);
		})
		socket.on('message', data => {
			if (data.type === 'game') {
				ctx.clearRect(0, 0, canvas.width, canvas.height);
				drawBall(data.status.ballX, data.status.ballY, data.status.ballRadius);
				drawBluePaddle(data.status.bluePaddleY, data.status.bluePaddleWidth, data.status.bluePaddleHeight);
				drawRedPaddle(data.status.redPaddleY, data.status.redPaddleWidth, data.status.redPaddleHeight);

				if (upPressedRed && data.status.redPaddleY > 0) {
					socket.emit('up', {
						roomId: data.status.roomId,
						role: 'red',
					})
				} 
				if (downPressedRed && data.status.redPaddleY < canvas.height - data.status.redPaddleHeight) {
					socket.emit('down', {
						roomId: data.status.roomId,
						role: 'red',
					})
				}
				if (upPressedBlue && data.status.bluePaddleY > 0) {
					socket.emit('up', {
						roomId: data.status.roomId,
						role: 'blue',
					})
				}
				if (downPressedBlue && data.status.bluePaddleY < canvas.height - data.status.bluePaddleHeight) {
					socket.emit('down', {
						roomId: data.status.roomId,
						role: 'blue',
					})
				}
				
			}
		})
		let canvas = document.getElementById("myCanvas");
		var ctx = canvas.getContext("2d");
		// var x = canvas.width / 2;
		// var y = canvas.height - 30;
		// var dx = 1;
		// var dy = -1.5; //숫자 크기가 속도를 결정
		// var ballRadius = 10;

		// var paddleHeight = 75;
		// var paddleWidth = 10;

		// var bluePaddleY = (canvas.height - paddleHeight) / 2;
		var upPressedBlue = false;
		var downPressedBlue = false;

		// var redPaddleY = (canvas.height - paddleHeight) / 2;
		var upPressedRed = false;
		var downPressedRed = false;

		const drawBall = (ballX, ballY, ballRadius) => {
			ctx.beginPath();
			ctx.arc(ballX, ballY, ballRadius, 0, Math.PI * 2);
			ctx.fillStyle = "#000000";
			ctx.fill();
			ctx.closePath();
		}

		function drawBluePaddle(y, width, height) {
			ctx.beginPath();
			ctx.rect(0, y, width, height);
			ctx.fillStyle = "#0095DD";
			ctx.fill();
			ctx.closePath();
		}

		function drawRedPaddle(y, width, height) {
			ctx.beginPath();
			ctx.rect(canvas.width - width, y, width, height);
			ctx.fillStyle = "#FF0088";
			ctx.fill();
			ctx.closePath();
		}

		function draw() {
			ctx.clearRect(0, 0, canvas.width, canvas.height); //clear
			drawBall();
			drawBluePaddle();
			drawRedPaddle();
			x += dx;
			y += dy;
			if (y + dy < ballRadius || y + dy > canvas.height - ballRadius) {
				dy *= -1;
			} else if (x + dx < ballRadius || x + dx > canvas.width - ballRadius) {
				if ((y > redPaddleY && y < redPaddleY + paddleHeight)
					|| (y > bluePaddleY && y < bluePaddleY + paddleHeight)) {
					dx *= -1;
				} else {
					// if (x === ballRadius)
					// 	alert("game win red!"); // game restart 버튼으로 대체 
					// else
					// 	alert("game win blue!");
				}
			}

			if (upPressedRed && redPaddleY > 0) {
				redPaddleY -= 5;
			} else if (downPressedRed && redPaddleY < canvas.height - paddleHeight) {
				// redPaddleY += 5;
				socket.emit('up', {
					roomId: 30,
					role: 'red',
				})
			}
			if (upPressedBlue && bluePaddleY > 0) {
				bluePaddleY -= 5;
			} else if (downPressedBlue && bluePaddleY < canvas.height - paddleHeight) {
				bluePaddleY += 5;
			}
		}
		const keyDownHandler = (e) => {
			if (e.keyCode === 38) {
				upPressedRed = true;
			} else if (e.keyCode === 40) {
				downPressedRed = true;
			}

			if (e.keyCode === 87) {
				upPressedBlue = true;
			} else if (e.keyCode === 83) {
				downPressedBlue = true;
			}
		}

		const keyUpHandler = (e) => {
			console.log(e.keyCode); // 방향키 위 : 38, 방향키 아래 : 40, 'w' : 87, 's': 83, esc : 27
			if (e.keyCode === 38) {
				upPressedRed = false;
			} else if (e.keyCode === 40) {
				downPressedRed = false;
			}

			if (e.keyCode === 87) {
				upPressedBlue = false;
			} else if (e.keyCode === 83) {
				downPressedBlue = false;
			}
		}

		document.addEventListener("keydown", keyDownHandler, false);
		document.addEventListener("keyup", keyUpHandler, false);
		// setInterval(draw, 10); //10ms 마다 draw 중


	</script>

</body>

</html>